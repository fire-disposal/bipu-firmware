name: Release Firmware

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build & Release
    runs-on: ubuntu-latest
    container: espressif/idf:latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Build Firmware
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          # 确保在正确的目录下编译
          idf.py set-target esp32s3
          idf.py build

      - name: Merge Binaries
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          # 使用 esptool 合并固件
          # 地址: bootloader @ 0x0, partition-table @ 0x8000, app @ 0x10000
          esptool.py --chip esp32s3 merge_bin \
            -o build/merged_firmware.bin \
            --flash_mode dio \
            --flash_size 16MB \
            --flash_freq 80m \
            0x0 build/bootloader/bootloader.bin \
            0x8000 build/partition_table/partition-table.bin \
            0x10000 build/bp_pager.bin

      - name: Rename Firmware
        run: |
          mv build/merged_firmware.bin build/bipupu_firmware_${{ github.ref_name }}.bin

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: build/bipupu_firmware_${{ github.ref_name }}.bin
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
