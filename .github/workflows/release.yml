name: Build & Merge Firmware

on:
  push:
    branches: [master, main]
    tags: ["v*"]
  pull_request:
    branches: [master]

permissions:
  contents: write

# 在 Job 级别定义默认环境变量，防止 context 访问失败
env:
  UPLOAD_NAME: "firmware_fallback.bin"

jobs:
  build:
    name: Build for ESP32-C3
    runs-on: ubuntu-latest
    container: espressif/idf:v5.5.2

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Build and Merge Firmware
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          rm -f sdkconfig
          idf.py set-target esp32c3
          idf.py build
          idf.py merge-bin

      - name: Prepare Artifacts
        id: prep
        shell: bash
        run: |
          DATETIME=$(TZ='Asia/Shanghai' date +'%Y%m%d_%H%M')
          FINAL_NAME="bipupu_c3_${DATETIME}.bin"
          
          # 检查文件是否存在再操作，增加健壮性
          if [ -f "build/merged-binary.bin" ]; then
            cp build/merged-binary.bin "$FINAL_NAME"
            echo "UPLOAD_NAME=$FINAL_NAME" >> $GITHUB_ENV
          else
            echo "::error::Merged binary not found!"
            exit 1
          fi

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          # name 是 GitHub 页面显示的压缩包名，固定为 firmware 比较整洁
          name: firmware-bin
          # 使用 || 语法确保 path 永远有效
          path: ${{ env.UPLOAD_NAME || 'build/merged-binary.bin' }}
          if-no-files-found: error

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # files 同样实装默认值保护
          files: ${{ env.UPLOAD_NAME || 'build/merged-binary.bin' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}