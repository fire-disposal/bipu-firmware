name: Build & Merge Firmware

on:
  push:
    # ä»…åœ¨æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0, v2.1.3-betaï¼‰
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build for ESP32-C3
    runs-on: ubuntu-latest
    # ä½¿ç”¨ Espressif å®˜æ–¹ Docker é•œåƒï¼Œç¯å¢ƒæ›´ç¨³å®š
    container: espressif/idf:v5.5.2

    steps:
      # ========= 1ï¸âƒ£ Checkout =========
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: "recursive"
          fetch-depth: 0 # å¿…é¡»è®¾ç½®ä¸º 0 æ‰èƒ½è·å–å®Œæ•´çš„æäº¤å†å²ç”¨äºç”Ÿæˆæ€»ç»“

      # ========= 2ï¸âƒ£ ç¼–è¯‘ä¸åˆå¹¶ =========
      - name: Build and Merge Firmware
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          rm -f sdkconfig
          idf.py set-target esp32c3
          idf.py build
          idf.py merge-bin

      # ========= 3ï¸âƒ£ å‡†å¤‡äº§ç‰©ä¸ç‰ˆæœ¬å· =========
      - name: Prepare Artifacts
        id: prep
        shell: bash
        run: |
          # è·å–å½“å‰ Tag å
          VERSION=${GITHUB_REF#refs/tags/}
          DATETIME=$(TZ='Asia/Shanghai' date +'%Y%m%d_%H%M')
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)

          # å®šä¹‰å›ºä»¶æ–‡ä»¶åï¼šé¡¹ç›®å_ç‰ˆæœ¬å·_æ—¶é—´_å“ˆå¸Œ.bin
          FINAL_NAME="firmware_${VERSION}_${DATETIME}_${SHORT_SHA}.bin"

          if [ -f "build/merged-binary.bin" ]; then
            cp build/merged-binary.bin "$FINAL_NAME"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "upload_name=$FINAL_NAME" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Merged binary not found!"
            exit 1
          fi

      # ========= 4ï¸âƒ£ è‡ªåŠ¨æå–æäº¤æ—¥å¿— (Comment æ€»ç»“) =========
      - name: Generate Release Body
        id: changelog
        shell: bash
        run: |
          # è·å–å½“å‰ tag ä¸ä¸Šä¸€ä¸ª tag ä¹‹é—´çš„æ‰€æœ‰ commit æ‘˜è¦
          # å¦‚æœæ˜¯ç¬¬ä¸€ä¸ª tagï¼Œåˆ™è·å–æ‰€æœ‰å†å²è®°å½•
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ github.ref }}^ 2>/dev/null || echo "")

          echo "### ğŸ›  å›ºä»¶æ›´æ–°è¯´æ˜" > release_body.md
          echo "- **è§¦å‘ç‰ˆæœ¬**: ${{ steps.prep.outputs.version }}" >> release_body.md
          echo "- **ç¼–è¯‘æ—¶é—´**: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (CST)" >> release_body.md
          echo "" >> release_body.md
          echo "#### ğŸ“ å˜æ›´æ‘˜è¦ (Recent Commits):" >> release_body.md

          if [ -z "$PREV_TAG" ]; then
            git log --pretty=format:"- %s ([%h](${{ github.server_url }}/${{ github.repository }}/commit/%H))" -n 10 >> release_body.md
          else
            git log ${PREV_TAG}..${{ github.ref }} --pretty=format:"- %s ([%h](${{ github.server_url }}/${{ github.repository }}/commit/%H))" >> release_body.md
          fi

      # ========= 5ï¸âƒ£ å‘å¸ƒ Release =========
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.prep.outputs.version }}
          name: "Release ${{ steps.prep.outputs.version }}"
          body_path: release_body.md
          files: |
            ${{ steps.prep.outputs.upload_name }}
          # æ­£å¼å‘å¸ƒè®¾ä¸º falseï¼Œå¦‚æœæ˜¯æµ‹è¯•ç‰ˆæœ¬å¯ä»¥æ”¹ä¸º true
          prerelease: false
          generate_release_notes: false # æˆ‘ä»¬å·²ç»æ‰‹åŠ¨ç”Ÿæˆäº†æ›´ç²¾ç®€çš„ body
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
