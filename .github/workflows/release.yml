name: Build & Merge Firmware

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master]

permissions:
  contents: write

env:
  UPLOAD_NAME: "firmware_fallback.bin"

jobs:
  build:
    name: Build for ESP32-C3
    runs-on: ubuntu-latest
    container: espressif/idf:v5.5.2

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Build and Merge Firmware
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          rm -f sdkconfig
          idf.py set-target esp32c3
          idf.py build
          idf.py merge-bin

      - name: Prepare Artifacts
        id: prep
        shell: bash
        run: |
          DATETIME=$(TZ='Asia/Shanghai' date +'%Y%m%d_%H%M')
          # 加入短哈希，方便在 Release 页面区分不同提交的固件
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          FINAL_NAME="bipupu_c3_${DATETIME}_${SHORT_SHA}.bin"
          
          if [ -f "build/merged-binary.bin" ]; then
            cp build/merged-binary.bin "$FINAL_NAME"
            echo "UPLOAD_NAME=$FINAL_NAME" >> $GITHUB_ENV
          else
            echo "::error::Merged binary not found!"
            exit 1
          fi

      - name: Create or Update Latest Release
        uses: softprops/action-gh-release@v2
        # 注意：这里移除了 if 限制，所有推送都会运行
        with:
          tag_name: latest  # 始终将固件推送到名为 'latest' 的 Release
          name: "Latest Continuous Build"
          body: "Last updated on ${{ github.event.head_commit.timestamp }} (Commit: ${{ github.sha }})"
          # 使用通配符确保不管文件名怎么变，只要是 .bin 都会被上传
          files: |
            *.bin
          # 设为预发布，这样它会排在正式版本之前，且适合频繁更新
          prerelease: true
          # 覆盖已存在的同名文件
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}